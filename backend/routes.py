from flask import request, jsonify, send_file\nfrom app import app, db, Project, Sketch, Part\nfrom geometry import SketchGeometry, Constraints, Part3D, FileExport\nimport json\nimport os\nfrom datetime import datetime\n\n# Project Routes\n@app.route('/api/projects', methods=['GET'])\ndef get_projects():\n    """Get all projects"""\n    projects = Project.query.all()\n    return jsonify([p.to_dict() for p in projects])\n\n@app.route('/api/projects', methods=['POST'])\ndef create_project():\n    """Create a new project"""\n    data = request.json\n    \n    project = Project(\n        name=data.get('name', 'Untitled Project'),\n        description=data.get('description', '')\n    )\n    \n    db.session.add(project)\n    db.session.commit()\n    \n    return jsonify(project.to_dict()), 201\n\n@app.route('/api/projects/<int:project_id>', methods=['GET'])\ndef get_project(project_id):\n    """Get project by ID"""\n    project = Project.query.get_or_404(project_id)\n    return jsonify(project.to_dict())\n\n@app.route('/api/projects/<int:project_id>', methods=['PUT'])\ndef update_project(project_id):\n    """Update project"""\n    project = Project.query.get_or_404(project_id)\n    data = request.json\n    \n    project.name = data.get('name', project.name)\n    project.description = data.get('description', project.description)\n    project.updated_at = datetime.utcnow()\n    \n    db.session.commit()\n    \n    return jsonify(project.to_dict())\n\n@app.route('/api/projects/<int:project_id>', methods=['DELETE'])\ndef delete_project(project_id):\n    """Delete project"""\n    project = Project.query.get_or_404(project_id)\n    db.session.delete(project)\n    db.session.commit()\n    \n    return '', 204\n\n# Sketch Routes\n@app.route('/api/projects/<int:project_id>/sketches', methods=['GET'])\ndef get_sketches(project_id):\n    """Get all sketches in a project"""\n    project = Project.query.get_or_404(project_id)\n    sketches = Sketch.query.filter_by(project_id=project_id).all()\n    return jsonify([s.to_dict() for s in sketches])\n\n@app.route('/api/projects/<int:project_id>/sketches', methods=['POST'])\ndef create_sketch(project_id):\n    """Create a new sketch"""\n    project = Project.query.get_or_404(project_id)\n    data = request.json\n    \n    sketch = Sketch(\n        project_id=project_id,\n        name=data.get('name', 'Sketch'),\n        geometry=json.dumps([]),\n        constraints=json.dumps([])\n    )\n    \n    db.session.add(sketch)\n    db.session.commit()\n    \n    return jsonify(sketch.to_dict()), 201\n\n@app.route('/api/sketches/<int:sketch_id>', methods=['GET'])\ndef get_sketch(sketch_id):\n    """Get sketch by ID"""\n    sketch = Sketch.query.get_or_404(sketch_id)\n    return jsonify(sketch.to_dict())\n\n@app.route('/api/sketches/<int:sketch_id>', methods=['PUT'])\ndef update_sketch(sketch_id):\n    """Update sketch geometry and constraints"""\n    sketch = Sketch.query.get_or_404(sketch_id)\n    data = request.json\n    \n    sketch.name = data.get('name', sketch.name)\n    sketch.geometry = json.dumps(data.get('geometry', []))\n    sketch.constraints = json.dumps(data.get('constraints', []))\n    sketch.updated_at = datetime.utcnow()\n    \n    db.session.commit()\n    \n    return jsonify(sketch.to_dict())\n\n@app.route('/api/sketches/<int:sketch_id>', methods=['DELETE'])\ndef delete_sketch(sketch_id):\n    """Delete sketch"""\n    sketch = Sketch.query.get_or_404(sketch_id)\n    db.session.delete(sketch)\n    db.session.commit()\n    \n    return '', 204\n\n# Part Routes\n@app.route('/api/projects/<int:project_id>/parts', methods=['GET'])\ndef get_parts(project_id):\n    """Get all parts in a project"""\n    project = Project.query.get_or_404(project_id)\n    parts = Part.query.filter_by(project_id=project_id).all()\n    return jsonify([p.to_dict() for p in parts])\n\n@app.route('/api/projects/<int:project_id>/parts', methods=['POST'])\ndef create_part(project_id):\n    """Create a new part"""\n    project = Project.query.get_or_404(project_id)\n    data = request.json\n    \n    part = Part(\n        project_id=project_id,\n        name=data.get('name', 'Part'),\n        sketch_id=data.get('sketch_id'),\n        operations=json.dumps([])\n    )\n    \n    db.session.add(part)\n    db.session.commit()\n    \n    return jsonify(part.to_dict()), 201\n\n@app.route('/api/parts/<int:part_id>', methods=['GET'])\ndef get_part(part_id):\n    """Get part by ID"""\n    part = Part.query.get_or_404(part_id)\n    return jsonify(part.to_dict())\n\n@app.route('/api/parts/<int:part_id>/extrude', methods=['POST'])\ndef extrude_part(part_id):\n    """Apply extrude operation to part"""\n    part = Part.query.get_or_404(part_id)\n    data = request.json\n    \n    depth = data.get('depth', 10)\n    \n    # Get the sketch\n    if not part.sketch_id:\n        return jsonify({'error': 'No sketch associated with part'}), 400\n    \n    sketch = Sketch.query.get_or_404(part.sketch_id)\n    geometry = json.loads(sketch.geometry)\n    \n    # Build wire and extrude\n    wire = SketchGeometry.build_wire_from_sketch(geometry)\n    if wire:\n        shape = Part3D.extrude(wire, depth)\n        \n        # Add operation to history\n        operations = json.loads(part.operations)\n        operations.append({'type': 'extrude', 'depth': depth})\n        part.operations = json.dumps(operations)\n        part.updated_at = datetime.utcnow()\n        \n        db.session.commit()\n        \n        return jsonify({\n            'message': 'Extrude operation applied',\n            'part': part.to_dict()\n        })\n    \n    return jsonify({'error': 'Could not build wire from sketch'}), 400\n\n@app.route('/api/parts/<int:part_id>/revolve', methods=['POST'])\ndef revolve_part(part_id):\n    """Apply revolve operation to part"""\n    part = Part.query.get_or_404(part_id)\n    data = request.json\n    \n    angle = data.get('angle', 360)\n    axis_origin = data.get('axis_origin', [0, 0, 0])\n    axis_direction = data.get('axis_direction', [0, 0, 1])\n    \n    if not part.sketch_id:\n        return jsonify({'error': 'No sketch associated with part'}), 400\n    \n    sketch = Sketch.query.get_or_404(part.sketch_id)\n    geometry = json.loads(sketch.geometry)\n    \n    wire = SketchGeometry.build_wire_from_sketch(geometry)\n    if wire:\n        shape = Part3D.revolve(wire, axis_origin, axis_direction, angle)\n        \n        operations = json.loads(part.operations)\n        operations.append({'type': 'revolve', 'angle': angle, 'axis_origin': axis_origin, 'axis_direction': axis_direction})\n        part.operations = json.dumps(operations)\n        part.updated_at = datetime.utcnow()\n        \n        db.session.commit()\n        \n        return jsonify({\n            'message': 'Revolve operation applied',\n            'part': part.to_dict()\n        })\n    \n    return jsonify({'error': 'Could not build wire from sketch'}), 400\n\n@app.route('/api/parts/<int:part_id>/fillet', methods=['POST'])\ndef fillet_part(part_id):\n    """Apply fillet operation to part"""\n    part = Part.query.get_or_404(part_id)\n    data = request.json\n    \n    radius = data.get('radius', 1)\n    edge_indices = data.get('edge_indices')\n    \n    operations = json.loads(part.operations)\n    operations.append({'type': 'fillet', 'radius': radius, 'edges': edge_indices})\n    part.operations = json.dumps(operations)\n    part.updated_at = datetime.utcnow()\n    \n    db.session.commit()\n    \n    return jsonify({\n        'message': 'Fillet operation applied',\n        'part': part.to_dict()\n    })\n\n@app.route('/api/parts/<int:part_id>/chamfer', methods=['POST'])\ndef chamfer_part(part_id):\n    """Apply chamfer operation to part"""\n    part = Part.query.get_or_404(part_id)\n    data = request.json\n    \n    size = data.get('size', 1)\n    edge_indices = data.get('edge_indices')\n    \n    operations = json.loads(part.operations)\n    operations.append({'type': 'chamfer', 'size': size, 'edges': edge_indices})\n    part.operations = json.dumps(operations)\n    part.updated_at = datetime.utcnow()\n    \n    db.session.commit()\n    \n    return jsonify({\n        'message': 'Chamfer operation applied',\n        'part': part.to_dict()\n    })\n\n@app.route('/api/parts/<int:part_id>/export/step', methods=['POST'])\ndef export_step(part_id):\n    """Export part to STEP format"""\n    part = Part.query.get_or_404(part_id)\n    \n    # Create filename\n    filename = f"{part.name}_{part.id}.step"\n    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)\n    \n    # Export (simplified - would need actual shape object)\n    success, message = FileExport.export_step(None, filepath)\n    \n    if success:\n        part.step_file_path = filepath\n        part.updated_at = datetime.utcnow()\n        db.session.commit()\n        \n        return jsonify({'message': message, 'file_path': filepath})\n    \n    return jsonify({'error': message}), 500\n\n@app.route('/api/parts/<int:part_id>/export/stl', methods=['POST'])\ndef export_stl(part_id):\n    """Export part to STL format"""\n    part = Part.query.get_or_404(part_id)\n    \n    filename = f"{part.name}_{part.id}.stl"\n    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)\n    \n    success, message = FileExport.export_stl(None, filepath)\n    \n    if success:\n        part.stl_file_path = filepath\n        part.updated_at = datetime.utcnow()\n        db.session.commit()\n        \n        return jsonify({'message': message, 'file_path': filepath})\n    \n    return jsonify({'error': message}), 500\n\n@app.route('/api/download/<filename>', methods=['GET'])\ndef download_file(filename):\n    """Download exported file"""\n    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)\n    \n    if os.path.exists(filepath):\n        return send_file(filepath, as_attachment=True)\n    \n    return jsonify({'error': 'File not found'}), 404\n