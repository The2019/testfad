from flask import Flask, request, jsonify, send_file\nfrom flask_cors import CORS\nfrom flask_sqlalchemy import SQLAlchemy\nimport os\nfrom dotenv import load_dotenv\nimport json\nfrom datetime import datetime\n\nload_dotenv()\n\napp = Flask(__name__)\nCORS(app)\n\n# Configuration\napp.config['SQLALCHEMY_DATABASE_URI'] = os.getenv('DATABASE_URL', 'sqlite:///cadapp.db')\napp.config['UPLOAD_FOLDER'] = os.path.join(os.path.dirname(__file__), '..', 'uploads')\napp.config['MAX_CONTENT_LENGTH'] = 100 * 1024 * 1024  # 100MB max file size\n\n# Create uploads directory\nos.makedirs(app.config['UPLOAD_FOLDER'], exist_ok=True)\n\ndb = SQLAlchemy(app)\n\n# Database Models\nclass Project(db.Model):\n    id = db.Column(db.Integer, primary_key=True)\n    name = db.Column(db.String(255), nullable=False)\n    description = db.Column(db.Text)\n    created_at = db.Column(db.DateTime, default=datetime.utcnow)\n    updated_at = db.Column(db.DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)\n    \n    sketches = db.relationship('Sketch', backref='project', lazy=True, cascade='all, delete-orphan')\n    parts = db.relationship('Part', backref='project', lazy=True, cascade='all, delete-orphan')\n    \n    def to_dict(self):\n        return {\n            'id': self.id,\n            'name': self.name,\n            'description': self.description,\n            'created_at': self.created_at.isoformat(),\n            'updated_at': self.updated_at.isoformat()\n        }\n\nclass Sketch(db.Model):\n    id = db.Column(db.Integer, primary_key=True)\n    project_id = db.Column(db.Integer, db.ForeignKey('project.id'), nullable=False)\n    name = db.Column(db.String(255), nullable=False)\n    geometry = db.Column(db.Text)  # JSON string\n    constraints = db.Column(db.Text)  # JSON string\n    created_at = db.Column(db.DateTime, default=datetime.utcnow)\n    updated_at = db.Column(db.DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)\n    \n    def to_dict(self):\n        return {\n            'id': self.id,\n            'project_id': self.project_id,\n            'name': self.name,\n            'geometry': json.loads(self.geometry) if self.geometry else [],\n            'constraints': json.loads(self.constraints) if self.constraints else [],\n            'created_at': self.created_at.isoformat(),\n            'updated_at': self.updated_at.isoformat()\n        }\n\nclass Part(db.Model):\n    id = db.Column(db.Integer, primary_key=True)\n    project_id = db.Column(db.Integer, db.ForeignKey('project.id'), nullable=False)\n    name = db.Column(db.String(255), nullable=False)\n    sketch_id = db.Column(db.Integer, db.ForeignKey('sketch.id'))\n    operations = db.Column(db.Text)  # JSON string\n    step_file_path = db.Column(db.String(512))\n    stl_file_path = db.Column(db.String(512))\n    created_at = db.Column(db.DateTime, default=datetime.utcnow)\n    updated_at = db.Column(db.DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)\n    \n    def to_dict(self):\n        return {\n            'id': self.id,\n            'project_id': self.project_id,\n            'name': self.name,\n            'sketch_id': self.sketch_id,\n            'operations': json.loads(self.operations) if self.operations else [],\n            'step_file_path': self.step_file_path,\n            'stl_file_path': self.stl_file_path,\n            'created_at': self.created_at.isoformat(),\n            'updated_at': self.updated_at.isoformat()\n        }\n\n# Initialize database\nwith app.app_context():\n    db.create_all()\n\nif __name__ == '__main__':\n    app.run(debug=True)